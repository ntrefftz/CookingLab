<h1>Mi Calendario Semanal</h1>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendarWk');

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridWeek', // Vista semanal
      editable: true, // Permitir edición de eventos
      events: [], // Puedes cargar eventos desde la base de datos si es necesario
      dateClick: async function (info) {
        // Mostrar un selector de recetas al hacer clic en un día
        const day = info.dateStr;

        // Obtener recetas desde el servidor
        const response = await fetch('/recetas/apirecetas');
        const recetas = await response.json();
        console.log('Recetas obtenidas:', recetas);
        
        const recipeSelector = document.createElement('select');
        recipeSelector.innerHTML = '<option value="">Selecciona una receta</option>';
        recetas.forEach(receta => {
          const option = document.createElement('option');
          option.value = receta.id; // Usa el ID de la receta
          option.textContent = receta.nombre; // Usa el nombre de la receta
          recipeSelector.appendChild(option);
        });

        const saveButton = document.createElement('button');
        saveButton.textContent = 'Guardar';
        saveButton.addEventListener('click', () => {
          const recipeId = recipeSelector.value;

          if (recipeId) {
            fetch('/guardar-receta', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ day, recipeId }),
            })
              .then(response => response.json())
              .then(data => {
                alert(data.message);
                calendar.addEvent({
                  title: recetas.find(r => r.id == recipeId).nombre, // Mostrar el nombre de la receta
                  start: day,
                });
              })
              .catch(error => {
                console.error('Error:', error);
              });
          } else {
            alert('Por favor selecciona una receta.');
          }
        });

        // Mostrar el selector y botón en el día seleccionado
        const content = document.createElement('div');
        content.appendChild(recipeSelector);
        content.appendChild(saveButton);

        const popup = document.createElement('div');
        popup.style.position = 'absolute';
        popup.style.background = '#fff';
        popup.style.border = '1px solid #ccc';
        popup.style.padding = '10px';
        popup.style.zIndex = '1000';
        popup.style.top = `${info.jsEvent.pageY}px`;
        popup.style.left = `${info.jsEvent.pageX}px`;
        popup.appendChild(content);

        document.body.appendChild(popup);

        // Cerrar el popup al hacer clic fuera
        document.addEventListener('click', function closePopup(event) {
          if (!popup.contains(event.target)) {
            popup.remove();
            document.removeEventListener('click', closePopup);
          }
        });
      },
    });

    calendar.render();
  });
</script>

<div id="calendarWk"></div>